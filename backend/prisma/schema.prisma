generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String                 @id @default(uuid())
  name                 String?
  email                String                 @unique
  password             String
  role                 Role
  tenantId             String?
  tenant               Tenant?                @relation(fields: [tenantId], references: [id])
  customRoleId         String?
  customRole           CustomRole?            @relation(fields: [customRoleId], references: [id])
  isFirstLogin         Boolean                @default(true)
  mustChangePassword   Boolean                @default(true)
  lastLoginAt          DateTime?
  passwordChangedAt    DateTime?
  systemSettings       SystemSetting[]
  settingHistory       SettingHistory[]
  emailTemplates       EmailTemplate[]
  activityLogs         ActivityLog[]
  backups              Backup[]
  createdAt            DateTime               @default(now())
  Notification         Notification[]
  NotificationTemplate NotificationTemplate[]
  TenantProfile        TenantProfile[]
  Campaign             Campaign[]
  emailLogs            EmailLog[]
}

model Tenant {
  id               String         @id @default(uuid())
  name             String
  email            String         @unique
  status           TenantStatus   @default(PENDING)
  subscriptionPlan String?
  users            User[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  ActivityLog      ActivityLog[]
  TenantProfile    TenantProfile?
  Campaign         Campaign[]
}

model CustomRole {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  permissions RolePermission[]
  users       User[]
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model RolePermission {
  id        String     @id @default(uuid())
  roleId    String
  role      CustomRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  module    String
  canView   Boolean    @default(false)
  canCreate Boolean    @default(false)
  canEdit   Boolean    @default(false)
  canDelete Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([roleId, module])
}

enum Role {
  SUPER_ADMIN
  TENANT_ADMIN
  USER
}

enum TenantStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

model SystemSetting {
  id            String           @id @default(uuid())
  category      String
  key           String
  value         String
  dataType      String
  description   String?
  updatedAt     DateTime         @updatedAt
  updatedBy     String
  updatedByUser User             @relation(fields: [updatedBy], references: [id])
  history       SettingHistory[]
  createdAt     DateTime         @default(now())

  @@unique([category, key])
}

model SettingHistory {
  id            String        @id @default(uuid())
  settingId     String
  setting       SystemSetting @relation(fields: [settingId], references: [id], onDelete: Cascade)
  oldValue      String
  newValue      String
  changedBy     String
  changedByUser User          @relation(fields: [changedBy], references: [id])
  changedAt     DateTime      @default(now())
  reason        String?
}

model EmailTemplate {
  id            String   @id @default(uuid())
  templateType  String   @unique
  subject       String
  bodyHtml      String
  bodyText      String
  variables     String
  isActive      Boolean  @default(true)
  version       Int      @default(1)
  updatedAt     DateTime @updatedAt
  updatedBy     String
  updatedByUser User     @relation(fields: [updatedBy], references: [id])
  createdAt     DateTime @default(now())
}

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  action      String
  module      String
  description String
  ipAddress   String?
  userAgent   String?
  status      String   @default("success")
  metadata    String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
}

model Notification {
  id            String    @id @default(uuid())
  title         String
  message       String
  type          String
  targetType    String
  targetId      String?
  isRead        Boolean   @default(false)
  scheduledAt   DateTime?
  sentAt        DateTime?
  createdBy     String
  createdByUser User      @relation(fields: [createdBy], references: [id])
  createdAt     DateTime  @default(now())

  @@index([targetType, targetId])
  @@index([isRead])
  @@index([scheduledAt])
}

model NotificationTemplate {
  id            String   @id @default(uuid())
  name          String   @unique
  title         String
  message       String
  type          String
  variables     String
  isActive      Boolean  @default(true)
  createdBy     String
  createdByUser User     @relation(fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Backup {
  id            String    @id @default(uuid())
  name          String
  type          String
  size          String?
  status        String    @default("pending")
  filePath      String?
  scheduledAt   DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  error         String?
  createdBy     String
  createdByUser User      @relation(fields: [createdBy], references: [id])
  createdAt     DateTime  @default(now())

  @@index([status])
  @@index([createdAt])
}

model TenantProfile {
  id             String    @id @default(uuid())
  tenantId       String    @unique
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  companyName    String
  companyLogo    String?
  industry       String?
  website        String?
  phone          String?
  address        String?
  city           String?
  state          String?
  country        String?
  zipCode        String?
  contactPerson  String?
  contactEmail   String?
  contactPhone   String?
  status         String    @default("pending")
  approvedBy     String?
  approvedByUser User?     @relation(fields: [approvedBy], references: [id])
  approvedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Campaign {
  id                String        @id @default(uuid())
  tenantId          String
  tenant            Tenant        @relation(fields: [tenantId], references: [id])
  name              String
  description       String?
  type              String
  status            String        @default("draft")
  scheduledAt       DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  autoStart         Boolean       @default(false)
  reminderSent      Boolean       @default(false)
  totalParticipants Int           @default(0)
  totalWinners      Int           @default(0)
  settings          String?
  createdBy         String
  createdByUser     User          @relation(fields: [createdBy], references: [id])
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  participants      Participant[]
  winners           Winner[]

  @@index([tenantId])
  @@index([status])
  @@index([scheduledAt])
}

model Participant {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name        String
  email       String?
  phone       String?
  status      String   @default("active")
  isDuplicate Boolean  @default(false)
  metadata    String?
  createdAt   DateTime @default(now())

  @@index([campaignId])
  @@index([email])
  @@index([phone])
}

model Winner {
  id         String   @id @default(uuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name       String
  email      String?
  phone      String?
  prize      String?
  position   Int
  notified   Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([campaignId])
}

model EmailLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  recipient   String
  subject     String
  body        String
  type        String
  status      String   @default("pending")
  error       String?
  sentAt      DateTime?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
